// PostgreSQL schema for production deployment (Railway)
// Copy this to schema.prisma before deploying to production
// Or use the setup:prod script

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===================
// CRM SYSTEM MODELS
// ===================

// Contact - Main customer/lead entity
model Contact {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  email       String   @unique
  phone       String?
  city        String?
  source      String?
  status      String   @default("active")
  type        String   @default("other")
  notes       String?
  avatar      String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tags        ContactTag[]
  leads       Lead[]
  deals       Deal[]
  activities  Activity[]
  interactions Interaction[]
  sentMessages SentMessage[]
  payments    Payment[]
  invoices    Invoice[]
  paymentPlans PaymentPlan[]
  recurringPayments RecurringPayment[]
  paymentReminders PaymentReminder[]
}

model Tag {
  id       String   @id @default(cuid())
  name     String   @unique
  color    String   @default("#6B7280")
  contacts ContactTag[]
}

model ContactTag {
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId String
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId     String
  assignedAt DateTime @default(now())
  @@id([contactId, tagId])
}

model Lead {
  id          String   @id @default(cuid())
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId   String
  status      String   @default("new")
  score       Int      @default(0)
  source      String?
  campaign    String?
  medium      String?
  product     Product? @relation(fields: [productId], references: [id])
  productId   String?
  assignedTo  String?
  nextFollowUp DateTime?
  lostReason  String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  convertedAt DateTime?
}

model Deal {
  id          String   @id @default(cuid())
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId   String
  product     Product  @relation(fields: [productId], references: [id])
  productId   String
  status      String   @default("pending")
  amount      Float
  currency    String   @default("ILS")
  discount    Float    @default(0)
  finalAmount Float
  paidAmount  Float    @default(0)
  paymentMethod String?
  paymentRef    String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  paidAt      DateTime?
  payments    Payment[]
  paymentPlans PaymentPlan[]
  paymentReminders PaymentReminder[]
}

model Product {
  id          String   @id @default(cuid())
  name        String
  nameHe      String?
  description String?
  price       Float
  currency    String   @default("ILS")
  category    String?
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  leads       Lead[]
  deals       Deal[]
  cartAbandonment CartAbandonment[]
  recurringPayments RecurringPayment[]
}

model Activity {
  id          String   @id @default(cuid())
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  contactId   String?
  type        String
  title       String
  description String?
  dueAt       DateTime?
  completedAt DateTime?
  createdBy   String?
  createdAt   DateTime @default(now())
}

model Interaction {
  id          String   @id @default(cuid())
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId   String
  type        String
  subject     String?
  content     String?
  channel     String?
  direction   String   @default("outbound")
  metadata    String?
  createdAt   DateTime @default(now())
}

model EmailSequence {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String
  isActive    Boolean  @default(true)
  emails      EmailTemplate[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EmailTemplate {
  id          String   @id @default(cuid())
  sequence    EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  sequenceId  String
  name        String
  subject     String
  body        String
  delayDays   Int      @default(0)
  delayHours  Int      @default(0)
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CartAbandonment {
  id          String   @id @default(cuid())
  email       String
  product     Product? @relation(fields: [productId], references: [id])
  productId   String?
  cartData    String?
  recoveryEmailsSent Int @default(0)
  isRecovered Boolean  @default(false)
  createdAt   DateTime @default(now())
  recoveredAt DateTime?
}

model PageView {
  id          String   @id @default(cuid())
  visitorId   String
  page        String
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  createdAt   DateTime @default(now())
}

model ConversionEvent {
  id          String   @id @default(cuid())
  visitorId   String
  eventType   String
  eventValue  Float?
  metadata    String?
  createdAt   DateTime @default(now())
}

model SocialMediaSettings {
  id          String   @id @default(cuid())
  platform    String   @unique
  isActive    Boolean  @default(false)
  phoneNumberId   String?
  businessAccountId String?
  accessToken     String?
  pageId          String?
  instagramId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MessageTemplate {
  id          String   @id @default(cuid())
  name        String
  platform    String
  category    String
  content     String
  mediaUrl    String?
  targetAudience String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sentMessages SentMessage[]
}

model SentMessage {
  id          String   @id @default(cuid())
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  contactId   String?
  template    MessageTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  templateId  String?
  platform    String
  recipient   String
  content     String
  status      String   @default("pending")
  externalId  String?
  errorMessage String?
  sentAt      DateTime @default(now())
  deliveredAt DateTime?
  readAt      DateTime?
}

model PaymentGatewaySettings {
  id            String   @id @default(cuid())
  gateway       String   @unique
  isActive      Boolean  @default(false)
  isDefault     Boolean  @default(false)
  terminalId    String?
  apiKey        String?
  apiSecret     String?
  webhookSecret String?
  settings      String?
  vatRate       Float    @default(17)
  invoicePrefix String?
  receiptPrefix String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Payment {
  id              String   @id @default(cuid())
  dealId          String?
  contactId       String
  amount          Float
  currency        String   @default("ILS")
  paymentMethod   String
  gateway         String?
  status          String   @default("pending")
  transactionId   String?
  authCode        String?
  last4Digits     String?
  cardBrand       String?
  errorCode       String?
  errorMessage    String?
  gatewayResponse String?
  notes           String?
  createdAt       DateTime @default(now())
  completedAt     DateTime?
  deal            Deal?    @relation(fields: [dealId], references: [id])
  contact         Contact  @relation(fields: [contactId], references: [id])
  invoice         Invoice?
  paymentPlan     PaymentPlan? @relation(fields: [paymentPlanId], references: [id])
  paymentPlanId   String?
  recurringPayment RecurringPayment? @relation(fields: [recurringPaymentId], references: [id])
  recurringPaymentId String?
}

model Invoice {
  id             String   @id @default(cuid())
  paymentId      String   @unique
  contactId      String
  invoiceNumber  String   @unique
  type           String
  subtotal       Float
  vatRate        Float    @default(17)
  vatAmount      Float
  totalAmount    Float
  issueDate      DateTime @default(now())
  dueDate        DateTime?
  lineItems      String
  customerName   String
  customerEmail  String
  customerPhone  String?
  customerTaxId  String?
  businessName   String?
  businessTaxId  String?
  status         String   @default("draft")
  pdfUrl         String?
  sentAt         DateTime?
  createdAt      DateTime @default(now())
  payment        Payment  @relation(fields: [paymentId], references: [id])
  contact        Contact  @relation(fields: [contactId], references: [id])
}

model PaymentPlan {
  id                String   @id @default(cuid())
  dealId            String
  contactId         String
  totalAmount       Float
  currency          String   @default("ILS")
  numberOfPayments  Int
  paymentFrequency  String   @default("monthly")
  startDate         DateTime
  nextPaymentDate   DateTime?
  paidAmount        Float    @default(0)
  paidInstallments  Int      @default(0)
  status            String   @default("active")
  paymentMethod     String?
  gateway           String?
  savedCardToken    String?
  createdAt         DateTime @default(now())
  completedAt       DateTime?
  deal              Deal     @relation(fields: [dealId], references: [id])
  contact           Contact  @relation(fields: [contactId], references: [id])
  payments          Payment[]
}

model RecurringPayment {
  id              String   @id @default(cuid())
  contactId       String
  productId       String?
  name            String
  amount          Float
  currency        String   @default("ILS")
  billingCycle    String   @default("monthly")
  startDate       DateTime
  nextBillingDate DateTime?
  status          String   @default("active")
  paymentMethod   String
  gateway         String?
  savedCardToken  String?
  totalCharges    Int      @default(0)
  totalRevenue    Float    @default(0)
  createdAt       DateTime @default(now())
  contact         Contact  @relation(fields: [contactId], references: [id])
  product         Product? @relation(fields: [productId], references: [id])
  payments        Payment[]
}

model PaymentReminder {
  id           String   @id @default(cuid())
  dealId       String?
  contactId    String
  type         String
  amount       Float?
  dueDate      DateTime?
  scheduledFor DateTime
  sendVia      String   @default("email")
  status       String   @default("pending")
  sentAt       DateTime?
  createdAt    DateTime @default(now())
  deal         Deal?    @relation(fields: [dealId], references: [id])
  contact      Contact  @relation(fields: [contactId], references: [id])
}
